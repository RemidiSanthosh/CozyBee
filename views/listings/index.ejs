<% layout("/layouts/boilerplate.ejs") %>

<!-- Bootstrap Icons -->
<link rel="stylesheet"
href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
/* ---------- FILTER BAR ---------- */
.filters-wrapper {
  position: sticky;
  top: 70px; /* adjust based on navbar height */
  z-index: 1000;

  background: #fff;
  padding: 0 2.5rem;
  margin-top: 1rem;
}

/* gradient fade edges */
.filters-wrapper::before,
.filters-wrapper::after {
  content: "";
  position: absolute;
  top: 0;
  width: 40px;
  height: 100%;
  pointer-events: none;
  z-index: 5;
}

.filters-wrapper::before {
  left: 0;
  background: linear-gradient(to right, #fff, transparent);
}

.filters-wrapper::after {
  right: 0;
  background: linear-gradient(to left, #fff, transparent);
}

/* ---------- FILTER SCROLL ---------- */
#filters {
  display: flex;
  align-items: center;
  gap: 2rem;

  overflow-x: auto;
  overflow-y: hidden;
  white-space: nowrap;

  padding: 1rem 0;

  scrollbar-width: none;
  cursor: grab;
}

#filters::-webkit-scrollbar {
  display: none;
}

#filters.active {
  cursor: grabbing;
}

/* ---------- FILTER ITEMS ---------- */
.filter {
  flex: 0 0 auto;
  min-width: 80px;
  text-align: center;
  opacity: 0.7;
  cursor: pointer;
  text-decoration: none;
  color: inherit;
}

.filter:hover {
  opacity: 1;
}

.filter i {
  font-size: 1.4rem;
}

.filter p {
  font-size: 0.75rem;
  margin-top: 0.25rem;
}

/* ---------- SCROLL BUTTON ---------- */
.scroll-btn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);

  background: #fff;
  border: 1px solid #ddd;
  border-radius: 50%;

  width: 36px;
  height: 36px;

  display: none;
  align-items: center;
  justify-content: center;

  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  cursor: pointer;
  z-index: 10;
}

.scroll-btn:hover {
  box-shadow: 0 3px 10px rgba(0,0,0,0.2);
}

.scroll-btn.left { left: 5px; }
.scroll-btn.right { right: 5px; }

/* ---------- MOBILE ---------- */
@media (max-width: 768px) {
  .scroll-btn {
    display: none !important;
  }
  .filters-wrapper {
    padding: 0 1rem;
  }
}
</style>

<!-- ---------- FILTER SECTION ---------- -->
<div class="filters-wrapper">

  <button id="leftBtn" class="scroll-btn left"
    onclick="scrollFilters(-250)">
    <i class="bi bi-chevron-left"></i>
  </button>

  <div id="filters">
    <a href="/listings?category=trending" class="filter">
      <i class="fa-solid fa-fire"></i><p>Trending</p>
    </a>

    <a href="/listings?category=rooms" class="filter">
      <i class="fa-solid fa-bed"></i><p>Rooms</p>
    </a>

    <a href="/listings?category=iconic" class="filter">
      <i class="fa-solid fa-mountain-city"></i><p>Iconic cities</p>
    </a>

    <a href="/listings?category=mountains" class="filter">
      <i class="fa-solid fa-mountain"></i><p>Mountains</p>
    </a>

    <a href="/listings?category=castles" class="filter">
      <i class="fa-brands fa-fort-awesome"></i><p>Castles</p>
    </a>

    <a href="/listings?category=pools" class="filter">
      <i class="fa-solid fa-person-swimming"></i><p>Pools</p>
    </a>

    <a href="/listings?category=camping" class="filter">
      <i class="fa-solid fa-campground"></i><p>Camping</p>
    </a>

    <a href="/listings?category=beach" class="filter">
      <i class="fa-solid fa-umbrella-beach"></i><p>Beach</p>
    </a>

    <a href="/listings?category=arctic" class="filter">
      <i class="fa-regular fa-snowflake"></i><p>Arctic</p>
    </a>

    <a href="/listings?category=domes" class="filter">
      <i class="fa-solid fa-igloo"></i><p>Domes</p>
    </a>

    <a href="/listings?category=cruise" class="filter">
      <i class="fa-solid fa-ship"></i><p>Cruise</p>
    </a>
  </div>

  <button id="rightBtn" class="scroll-btn right"
    onclick="scrollFilters(250)">
    <i class="bi bi-chevron-right"></i>
  </button>
</div>

<!-- ---------- LISTINGS ---------- -->
<div class="row row-cols-lg-3 row-cols-md-2 row-cols-sm-1 mt-4">
  <% for (let listing of allListings) { %>
    <a href="/listings/<%= listing._id %>" class="listing-link">
      <div class="card col listing-card">
        <img src="<%= listing.image.url %>"
             class="card-img-top"
             style="height:20rem;">
        <div class="card-body">
          <p>
            <b><%= listing.title %></b><br>
                &#8377;<span class="base-price">
                <%= listing.price?.toLocaleString() || "N/A" %>
                </span>

              <span class="tax-info" style="display:none;">
                (+18% GST:
                &#8377;<%= Math.round(listing.price * 1.18).toLocaleString() %>)
              </span>
              /night
          </p>
        </div>
      </div>
    </a>
  <% } %>
</div>

<!-- ---------- SCRIPT ---------- -->
<script>
const filters = document.getElementById("filters");
const leftBtn = document.getElementById("leftBtn");
const rightBtn = document.getElementById("rightBtn");

function updateButtons() {
  const maxScroll = filters.scrollWidth - filters.clientWidth;
  const current = filters.scrollLeft;

  leftBtn.style.display = current > 5 ? "flex" : "none";
  rightBtn.style.display =
    current < maxScroll - 5 ? "flex" : "none";
}

function scrollFilters(amount) {
  filters.scrollBy({ left: amount, behavior: "smooth" });
}

/* Button visibility updates */
filters.addEventListener("scroll", updateButtons);
window.addEventListener("load", updateButtons);
window.addEventListener("resize", updateButtons);

/* ---------- DRAG SCROLL ---------- */
let isDown = false;
let startX;
let scrollLeft;

filters.addEventListener("mousedown", e => {
  isDown = true;
  filters.classList.add("active");
  startX = e.pageX - filters.offsetLeft;
  scrollLeft = filters.scrollLeft;
});

filters.addEventListener("mouseleave", () => {
  isDown = false;
  filters.classList.remove("active");
});

filters.addEventListener("mouseup", () => {
  isDown = false;
  filters.classList.remove("active");
});

filters.addEventListener("mousemove", e => {
  if (!isDown) return;
  e.preventDefault();
  const x = e.pageX - filters.offsetLeft;
  const walk = (x - startX) * 1.5;
  filters.scrollLeft = scrollLeft - walk;
});
</script>
